---
- hosts: ha-nfs
  gather_facts: true
  roles:
    - role: setup-hosts
      terraform_outputs_path: "/home/sumi/Templates/nix/nixos-k8s-config/terraform/nfs/development.json"

    - role: initRHEL
      install_pkgs:
        - kmod-drbd9x
        - drbd9x-utils
        - cryptsetup
        - lvm2
        - firewalld
      repos: "epel,elrepo"
      modprobes:
        - drbd

          #    - role: setup-luks
          #      luksname: "cryptolvm"
          #      luksdevice: "/dev/sdb"
          #      lukspassphrase: "cryptolvm"
          #
          #    - role: setup-drbd
          #      drbdport: 7789
          #      resource:
          #        - name: "nfs1"
          #          id: 0
          #          address: "10.150.10.70"
          #          meta_disk: "internal"
          #          volumes:
          #            - "/dev/mapper/cryptolvm"
          #        - name: "nfs2"
          #          id: 1
          #          address: "10.150.10.71"
          #          meta_disk: "internal"
          #          volumes:
          #            - "/dev/mapper/cryptolvm"

    - role: ondrejhome.ha-cluster-pacemaker
      cluster_name: "ha-cluster"
      cluster_user_pass: "almalinux"
      cluster_firewall: true
      cluster_configure_fence_xvm: false
      cluster_resource:
        - name: "drbd_r0"
          resource_class: "ocf"
          resource_type: "linbit:drbd"
          options: "drbd_resource=r0 op monitor interval=10s promotable monitor interval=30s meta promotable-max=1 promotable-node-max=1 clone-max=2 clone-node-max=1 notify=true"

  # - role: geerlingguy.nfs
